<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ ch∆°i Ma S√≥i</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/player.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/voting.css">
    <link rel="stylesheet" href="css/night-notes.css">
    <link rel="stylesheet" href="css/modal.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Tr√≤ ch∆°i Ma S√≥i</h1>
        </div>
        
        <!-- M√†n h√¨nh l·ª±a ch·ªçn vai tr√≤ -->
        <div id="roleSelectionScreen" class="section role-selection">
            <h2>Ch·ªçn vai tr√≤ c·ªßa b·∫°n</h2>
            <div class="role-options">
                <div class="role-option" onclick="selectUserRole('player')">
                    <div class="role-icon">üë§</div>
                    <h3>Ng∆∞·ªùi Ch∆°i</h3>
                    <p>ƒêƒÉng nh·∫≠p ƒë·ªÉ xem vai tr√≤ c·ªßa b·∫°n</p>
                </div>
                <div class="role-option" onclick="selectUserRole('gameMaster')">
                    <div class="role-icon">üëë</div>
                    <h3>Qu·∫£n Tr√≤</h3>
                    <p>Qu·∫£n l√Ω tr√≤ ch∆°i v√† theo d√µi ng∆∞·ªùi ch∆°i</p>
                </div>
            </div>
        </div>
        
        <!-- Modal nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr√≤ -->
        <div id="passwordModal" class="modal-overlay hidden">
            <div class="modal">
                <h3>Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr√≤</h3>
                <div class="password-container">
                    <input type="password" id="masterPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('masterPassword')">
                        <span class="show-icon">üëÅÔ∏è</span>
                    </button>
                </div>
                <div id="passwordError" class="error-message hidden">M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!</div>
                <div class="btn-group">
                    <button onclick="verifyPassword()">X√°c nh·∫≠n</button>
                    <button onclick="cancelPasswordModal()">H·ªßy</button>
                </div>
            </div>
        </div>

        <!-- Modal x√°c nh·∫≠n -->
        <div id="confirmModal" class="modal-overlay hidden">
            <div class="modal">
                <h3 id="confirmTitle">X√°c nh·∫≠n h√†nh ƒë·ªông</h3>
                <p id="confirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông n√†y?</p>
                <div class="btn-group">
                    <button id="confirmYesBtn" onclick="handleConfirmYes()">ƒê·ªìng √Ω</button>
                    <button onclick="closeConfirmModal()">H·ªßy</button>
                </div>
            </div>
        </div>

        <!-- Ph·∫ßn thi·∫øt l·∫≠p tr√≤ ch∆°i (qu·∫£n tr√≤) -->
        <div id="setupContainer" class="hidden section">
            <h2>Qu·∫£n l√Ω tr√≤ ch∆°i</h2>
            
            <div class="sheets-info">
                <h3>C·∫•u h√¨nh Google Sheets</h3>
                <p>D·ªØ li·ªáu ng∆∞·ªùi ch∆°i ƒë∆∞·ª£c t·∫£i t·ª´ Google Sheets.</p>
                <div id="sheetsStatus">
                    <div class="loader"></div>
                    <p>ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...</p>
                </div>
            </div>
            
            <button id="refreshSheetsBtn" onclick="refreshSheetsData()">L√†m m·ªõi d·ªØ li·ªáu t·ª´ Google Sheets</button>
            
            <div class="btn-group" style="margin-top: 15px;">
                <button id="createGameBtn" onclick="setupGame()">T·∫°o ph√≤ng ch∆°i m·ªõi</button>
            </div>
            
            <div id="gameCode" class="hidden role-display">
                M√£ tr√≤ ch∆°i: <span id="code" class="room-code"></span>
            </div>
            <div id="setupStatus" class="hidden status-bar"></div>
        </div>

        <!-- Ph·∫ßn danh s√°ch ph√≤ng cho qu·∫£n tr√≤ -->
        <div id="adminRoomsContainer" class="hidden section">
            <h2>Danh s√°ch ph√≤ng</h2>
            <button onclick="loadRooms(true)">L√†m m·ªõi danh s√°ch</button>
            <div id="adminRoomsList" class="room-list"></div>
        </div>

        <!-- Ph·∫ßn ng∆∞·ªùi ch∆°i ƒëƒÉng nh·∫≠p -->
        <div id="playerContainer" class="hidden section">
            <h2>Tr√≤ ch∆°i Ma S√≥i</h2>
            
            <div class="login-form">
                <h3>ƒêƒÉng nh·∫≠p</h3>
                <p>Nh·∫≠p m·∫≠t kh·∫©u c·ªßa b·∫°n ƒë·ªÉ xem vai tr√≤</p>
                <div class="password-container">
                    <input type="password" id="playerPassword" placeholder="M·∫≠t kh·∫©u">
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('playerPassword')">
                        <span class="show-icon">üëÅÔ∏è</span>
                    </button>
                </div>
                <div id="loginStatus" class="hidden status-bar"></div>
                <button onclick="playerLogin()">ƒêƒÉng nh·∫≠p</button>
            </div>
            
            <div id="playerRoleView" class="hidden">
                <div id="roleResult" class="role-display">
                    <h3>Th√¥ng tin c·ªßa b·∫°n</h3>
                    <p>T√™n hi·ªÉn th·ªã: <span id="displayName"></span></p>
                    <p>Vai tr√≤: <span id="role"></span></p>
                    <div id="deadNotice" class="hidden" style="margin-top: 10px; color: #b71c1c;">
                        B·∫°n ƒë√£ b·ªã lo·∫°i kh·ªèi tr√≤ ch∆°i
                    </div>
                </div>
                
                <!-- Th√™m ph·∫ßn th√¥ng tin tr√≤ ch∆°i cho ng∆∞·ªùi ch∆°i -->
                <div id="gameInfoForPlayer" class="role-display" style="background-color: #e3f2fd; border-left-color: var(--accent-color); margin-top: 20px;">
                    <h3>Th√¥ng tin tr√≤ ch∆°i</h3>
                    <div class="game-stats">
                        <p>S·ªë ng∆∞·ªùi ch∆°i: <span id="playerAliveCount">0</span>/<span id="playerTotalCount">0</span></p>
                    </div>
                    <div class="role-list-container">
                        <h4>Vai tr√≤ trong game:</h4>
                        <ul id="roleListForPlayer" class="role-list">
                            <!-- Danh s√°ch vai tr√≤ s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                        </ul>
                    </div>
                </div>
                
                <div id="waitingForGameStart" class="hidden role-display" style="background-color: #e8f4fd; border-left-color: var(--accent-color);">
                    <h3>ƒêang ch·ªù qu·∫£n tr√≤ b·∫Øt ƒë·∫ßu tr√≤ ch∆°i</h3>
                    <p>Vai tr√≤ c·ªßa b·∫°n s·∫Ω hi·ªÉn th·ªã khi qu·∫£n tr√≤ b·∫Øt ƒë·∫ßu tr√≤ ch∆°i.</p>
                    <div class="loader" style="margin: 15px auto;"></div>
                </div>
                
                <div id="gameEndedNotice" class="hidden role-display" style="background-color: #ffebee; border-left-color: var(--danger-color);">
                    <h3>Tr√≤ ch∆°i ƒë√£ k·∫øt th√∫c</h3>
                    <p>Tr√≤ ch∆°i ƒë√£ k·∫øt th√∫c, vui l√≤ng ch·ªù qu·∫£n tr√≤ b·∫Øt ƒë·∫ßu l·∫°i tr√≤ ch∆°i.</p>
                    <div class="loader" style="margin: 15px auto;"></div>
                </div>
                
                <button onclick="playerLogout()" style="margin-top: 20px;">ƒêƒÉng xu·∫•t</button>
                
                <!-- Ph·∫ßn b·ªè phi·∫øu cho ng∆∞·ªùi ch∆°i -->
                <div id="playerVotingContainer" class="voting-container">
                    <h3>B·ªè phi·∫øu lo·∫°i ng∆∞·ªùi ch∆°i</h3>
                    <div id="playerVotingStatus" class="voting-status inactive">
                        Hi·ªán kh√¥ng c√≥ phi√™n b·ªè phi·∫øu n√†o ƒëang di·ªÖn ra
                    </div>
                    <div id="playerVotingTimer" class="voting-timer hidden">
                        Th·ªùi gian c√≤n l·∫°i: <span id="playerCountdown" class="countdown">00:00</span>
                    </div>
                    <div id="playerVotingOptions" class="voting-options"></div>
                    <div id="playerVoteConfirmation" class="hidden status-bar">
                        B·∫°n ƒë√£ b·ªè phi·∫øu cho: <span id="playerVoteChoice"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ph·∫ßn qu·∫£n tr√≤ xem vai tr√≤ -->
        <div id="adminContainer" class="hidden section">
            <h2>Qu·∫£n l√Ω vai tr√≤</h2>
            <div id="adminSearchArea">
                <input type="text" id="adminGameCode" placeholder="Nh·∫≠p m√£ ph√≤ng ƒë·ªÉ xem">
                <button onclick="viewRoles()">Xem vai tr√≤</button>
            </div>
            <div id="adminGameInfo" class="hidden">
                <div class="status-bar">
                    ƒêang xem ph√≤ng: <span id="adminCurrentRoom" class="room-code"></span>
                </div>
                <div id="adminStatus" class="status-bar">
                    S·ªë ng∆∞·ªùi ch∆°i: <span id="adminCurrentPlayers">0</span>/<span id="adminTotalPlayers">0</span>
                </div>
                <!-- Th√™m th√¥ng b√°o ng∆∞·ªùi ch∆°i ƒë√£ ƒëƒÉng nh·∫≠p -->
                <div id="adminPlayersLogged" class="status-bar info">
                    S·ªë ng∆∞·ªùi ch∆°i ƒë√£ ƒëƒÉng nh·∫≠p: <span id="loggedPlayersCount">0</span>
                </div>
                
                <!-- Section qu·∫£n l√Ω ng∆∞·ªùi ch∆°i c√≥ th·ªÉ thu g·ªçn -->
                <div id="playerManagementSection" class="admin-section">
                    <div class="section-header" onclick="toggleSection('playerManagementSection')">
                        <h3>Qu·∫£n l√Ω ng∆∞·ªùi ch∆°i</h3>
                        <span class="toggle-icon"></span>
                    </div>
                    <div class="section-content">
                        <div id="roleTableContainer"></div>
                        
                        <!-- Thay th·∫ø n√∫t c·∫≠p nh·∫≠t t·ª´ Google Sheets b·∫±ng c√°c n√∫t m·ªõi -->
                        <div class="btn-group" style="margin-top: 20px;">
                            <button onclick="refreshRolesFromSheet()" class="secondary">C·∫≠p nh·∫≠t</button>
                            <button onclick="startGameForPlayers()" class="primary" id="startGameButton">B·∫Øt ƒë·∫ßu</button>
                            <button onclick="endGame()" class="delete" id="endGameButton">K·∫øt Th√∫c Tr√≤ Ch∆°i</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ph·∫ßn qu·∫£n l√Ω b·ªè phi·∫øu cho qu·∫£n tr√≤ -->
                <div id="votingSection" class="admin-section">
                    <div class="section-header" onclick="toggleSection('votingSection')">
                        <h3>Qu·∫£n l√Ω b·ªè phi·∫øu</h3>
                        <span class="toggle-icon"></span>
                    </div>
                    <div class="section-content">
                        <div id="votingContainer" class="voting-container">
                            <div id="votingStatus" class="voting-status inactive">
                                Ch∆∞a b·∫Øt ƒë·∫ßu phi√™n b·ªè phi·∫øu n√†o
                            </div>
                            
                            <div id="votingControls">
                                <div class="input-group">
                                    <label for="votingDuration">Th·ªùi gian b·ªè phi·∫øu (gi√¢y):</label>
                                    <input type="number" id="votingDuration" value="60" min="10" max="300">
                                </div>
                                <button id="startVotingBtn" onclick="startVoting()" class="voting">B·∫Øt ƒë·∫ßu b·ªè phi·∫øu</button>
                                <button id="endVotingBtn" onclick="endVoting()" class="delete hidden">K·∫øt th√∫c b·ªè phi·∫øu ngay</button>
                            </div>
                            
                            <div id="votingTimer" class="voting-timer hidden">
                                Th·ªùi gian c√≤n l·∫°i: <span id="countdown" class="countdown">00:00</span>
                            </div>
                            
                            <div id="votingResults" class="voting-results hidden">
                                <h3>K·∫øt qu·∫£ b·ªè phi·∫øu</h3>
                                <div id="votingResultsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ph·∫ßn ghi ch√∫ ƒë√™m -->
                <div id="nightNotesSection" class="admin-section">
                    <div class="section-header" onclick="toggleSection('nightNotesSection')">
                        <h3>Ghi Ch√∫ H√†nh ƒê·ªông C√°c ƒê√™m</h3>
                        <span class="toggle-icon"></span>
                    </div>
                    <div class="section-content">
                        <div id="gameNotesContainer" class="game-notes-container">
                            <div id="nightTabs" class="night-tabs">
                                <!-- C√°c tab ƒë√™m s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
                                <button class="add-night-btn" onclick="addNewNight()">+ Th√™m ƒë√™m</button>
                            </div>
                            
                            <div id="nightsContent">
                                <!-- N·ªôi dung ghi ch√∫ t·ª´ng ƒë√™m s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="deleteCurrentRoom()" class="delete" style="margin-top: 20px;">X√≥a ph√≤ng</button>
            </div>
        </div>
        
        <div class="footer">
            <p>Ma S√≥i ¬© 2025 | Phi√™n b·∫£n 2.0</p>
            <p id="switchRole" class="hidden">
                <a href="#" onclick="switchUserRole()">Chuy·ªÉn ƒë·ªïi vai tr√≤</a>
            </p>
        </div>
    </div>

    <!-- JavaScript modules -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/player.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/game.js"></script>
    <script src="js/voting.js"></script>
    <script src="js/night-notes.js"></script>
    <script src="js/app.js"></script>
</body>
</html>