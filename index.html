<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trò chơi Ma Sói</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #2E7D32;
            --accent-color: #1a73e8;
            --danger-color: #f44336;
            --danger-dark: #d32f2f;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --text-dark: #333;
            --text-light: #fff;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
            --warning-color: #ff9800;
            --voting-color: #9c27b0;
            --voting-dark: #7b1fa2;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        .hidden {
            display: none !important;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            color: var(--text-dark);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .header h1 {
            color: var(--primary-dark);
            font-size: 2.2rem;
        }
        
        .section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }
        
        h2 {
            color: var(--primary-dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        h3 {
            color: var(--primary-dark);
            margin: 20px 0 15px 0;
        }
        
        input, button, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-size: 16px;
            outline: none;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        input:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        button.delete {
            background-color: var(--danger-color);
        }
        
        button.delete:hover {
            background-color: var(--danger-dark);
        }

        button.secondary {
            background-color: #607d8b;
        }

        button.secondary:hover {
            background-color: #455a64;
        }

        button.voting {
            background-color: var(--voting-color);
        }

        button.voting:hover {
            background-color: var(--voting-dark);
        }

        button.warning {
            background-color: var(--warning-color);
        }

        button.warning:hover {
            background-color: #e69500;
        }

        button.icon {
            width: auto;
            min-width: 40px;
            height: 40px;
            padding: 8px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .btn-group button {
            flex: 1;
        }
        
        .status-bar {
            background-color: #f0f0f0;
            padding: 12px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }
        
        .status-bar.full {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-bar.empty {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-bar.voting {
            background-color: #ede7f6;
            color: var(--voting-dark);
            border-left: 4px solid var(--voting-color);
        }

        .status-bar.info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        
        .room-list {
            margin-top: 20px;
        }
        
        .room-item {
            background-color: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: var(--card-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .room-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .room-info {
            flex: 1;
        }
        
        .room-actions {
            display: flex;
            gap: 10px;
        }
        
        .room-actions button {
            width: auto;
            padding: 8px 15px;
        }
        
        .room-code {
            font-weight: bold;
            color: var(--accent-color);
        }
        
        /* Bảng vai trò */
        .role-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .role-table th, .role-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .role-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        
        .role-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .role-table tr:hover {
            background-color: #f0f8ff;
        }

        .role-table tr.dead {
            background-color: #ffebee;
            color: #9e9e9e;
            text-decoration: line-through;
        }

        .role-table .player-actions {
            display: flex;
            gap: 5px;
        }

        .role-table .player-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 6px;
        }

        .role-table .dead-status {
            background-color: #ffebee;
            color: #b71c1c;
        }
        
        /* Role display for player */
        .role-display {
            background-color: #e8f5e9;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            border-left: 4px solid var(--primary-color);
        }

        .role-display.dead {
            background-color: #ffebee;
            border-left-color: var(--danger-color);
            color: #b71c1c;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal h3 {
            margin-bottom: 15px;
            color: var(--primary-dark);
        }
        
        .error-message {
            color: var(--danger-color);
            margin: 10px 0;
            font-weight: bold;
        }
        
        /* Role selection screen */
        .role-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 30px 0;
        }
        
        .role-options {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .role-option {
            width: 45%;
            min-width: 200px;
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .role-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }
        
        .role-option h3 {
            color: var(--primary-dark);
            margin-bottom: 10px;
        }
        
        .role-option p {
            color: #666;
        }
        
        .role-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .footer {
            text-align: center;
            margin-top: 50px;
            color: #666;
            font-size: 0.9rem;
        }

        /* Game notes section */
        .game-notes-container {
            margin-top: 30px;
            border-top: 2px dashed #ddd;
            padding-top: 20px;
        }

        .night-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 15px 0;
        }

        .night-tab {
            padding: 8px 15px;
            background-color: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: bold;
            border: none;
            width: auto;
        }

        .night-tab:hover {
            background-color: #e0e0e0;
            transform: translateY(0);
        }

        .night-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .note-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .night-content {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fafafa;
        }

        .note-preview {
            white-space: pre-wrap;
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #eee;
            max-height: 200px;
            overflow-y: auto;
        }

        .add-night-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 15px;
            background-color: var(--warning-color);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 10px;
            width: auto;
            font-weight: bold;
        }

        .add-night-btn:hover {
            background-color: #e69500;
        }

        /* Voting system styles */
        .voting-container {
            margin-top: 30px;
            border-top: 2px dashed #ddd;
            padding-top: 20px;
        }

        .voting-timer {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .voting-options {
            margin: 15px 0;
        }

        .vote-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background-color: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .vote-option:hover {
            background-color: #e9ecef;
            border-color: var(--accent-color);
        }

        .vote-option.selected {
            background-color: #e3f2fd;
            border-color: var(--accent-color);
        }

        .vote-count {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 15px;
            background-color: #e9ecef;
        }

        .voting-results {
            margin-top: 20px;
        }

        .voting-results-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .voting-result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .voting-result-winner {
            background-color: #ffebee;
            border-left: 4px solid var(--danger-color);
            font-weight: bold;
        }

        .voting-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .voting-status.active {
            background-color: #ede7f6;
            color: var(--voting-dark);
        }

        .voting-status.inactive {
            background-color: #f5f5f5;
            color: #757575;
        }

        .voting-status.completed {
            background-color: #e8eaf6;
            color: #3f51b5;
        }

        .countdown {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--voting-color);
        }

        /* Animation for role change */
        @keyframes flash {
            0%, 100% { background-color: #e8f5e9; }
            50% { background-color: #a5d6a7; }
        }
        
        .role-flash {
            animation: flash 1s 3;
        }
        
        /* Player login form */
        .login-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .sheets-info {
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            border-left: 4px solid var(--accent-color);
        }
        
        .loader {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .role-options {
                flex-direction: column;
            }
            
            .role-option {
                width: 100%;
            }
            
            .room-item {
                flex-direction: column;
            }
            
            .room-actions {
                margin-top: 10px;
                width: 100%;
            }
            
            .room-actions button {
                width: 100%;
            }
            
            .btn-group {
                flex-direction: column;
            }

            .night-tab {
                font-size: 14px;
                padding: 6px 12px;
            }
        }
    </style>
    <!-- Firebase SDK phiên bản 8.x -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Trò chơi Ma Sói</h1>
        </div>
        
        <!-- Màn hình lựa chọn vai trò -->
        <div id="roleSelectionScreen" class="section role-selection">
            <h2>Chọn vai trò của bạn</h2>
            <div class="role-options">
                <div class="role-option" onclick="selectUserRole('player')">
                    <div class="role-icon">👤</div>
                    <h3>Người Chơi</h3>
                    <p>Đăng nhập để xem vai trò của bạn</p>
                </div>
                <div class="role-option" onclick="selectUserRole('gameMaster')">
                    <div class="role-icon">👑</div>
                    <h3>Quản Trò</h3>
                    <p>Quản lý trò chơi và theo dõi người chơi</p>
                </div>
            </div>
        </div>
        
        <!-- Modal nhập mật khẩu quản trò -->
        <div id="passwordModal" class="modal-overlay hidden">
            <div class="modal">
                <h3>Nhập mật khẩu quản trò</h3>
                <input type="password" id="masterPassword" placeholder="Nhập mật khẩu">
                <div id="passwordError" class="error-message hidden">Mật khẩu không chính xác!</div>
                <div class="btn-group">
                    <button onclick="verifyPassword()">Xác nhận</button>
                    <button onclick="cancelPasswordModal()">Hủy</button>
                </div>
            </div>
        </div>

        <!-- Modal xác nhận -->
        <div id="confirmModal" class="modal-overlay hidden">
            <div class="modal">
                <h3 id="confirmTitle">Xác nhận hành động</h3>
                <p id="confirmMessage">Bạn có chắc chắn muốn thực hiện hành động này?</p>
                <div class="btn-group">
                    <button id="confirmYesBtn" onclick="handleConfirmYes()">Đồng ý</button>
                    <button onclick="closeConfirmModal()">Hủy</button>
                </div>
            </div>
        </div>

        <!-- Phần thiết lập trò chơi (quản trò) -->
        <div id="setupContainer" class="hidden section">
            <h2>Quản lý trò chơi</h2>
            
            <div class="sheets-info">
                <h3>Cấu hình Google Sheets</h3>
                <p>Dữ liệu người chơi được tải từ Google Sheets.</p>
                <div id="sheetsStatus">
                    <div class="loader"></div>
                    <p>Đang tải dữ liệu từ Google Sheets...</p>
                </div>
            </div>
            
            <button id="refreshSheetsBtn" onclick="refreshSheetsData()">Làm mới dữ liệu từ Google Sheets</button>
            
            <div class="btn-group" style="margin-top: 15px;">
                <button id="createGameBtn" onclick="setupGame()">Tạo phòng chơi mới</button>
            </div>
            
            <div id="gameCode" class="hidden role-display">
                Mã trò chơi: <span id="code" class="room-code"></span>
            </div>
            <div id="setupStatus" class="hidden status-bar"></div>
        </div>

        <!-- Phần danh sách phòng cho quản trò -->
        <div id="adminRoomsContainer" class="hidden section">
            <h2>Danh sách phòng</h2>
            <button onclick="loadRooms(true)">Làm mới danh sách</button>
            <div id="adminRoomsList" class="room-list"></div>
        </div>

        <!-- Phần người chơi đăng nhập -->
        <div id="playerContainer" class="hidden section">
            <h2>Trò chơi Ma Sói</h2>
            
            <div class="login-form">
                <h3>Đăng nhập</h3>
                <p>Nhập tên đăng nhập và mật khẩu của bạn để xem vai trò</p>
                <input type="text" id="playerLoginName" placeholder="Tên đăng nhập">
                <input type="password" id="playerPassword" placeholder="Mật khẩu">
                <div id="loginStatus" class="hidden status-bar"></div>
                <button onclick="playerLogin()">Đăng nhập</button>
            </div>
            
            <div id="playerRoleView" class="hidden">
                <div id="roleResult" class="role-display">
                    <h3>Thông tin của bạn</h3>
                    <p>Tên hiển thị: <span id="displayName"></span></p>
                    <p>Vai trò: <span id="role"></span></p>
                    <div id="deadNotice" class="hidden" style="margin-top: 10px; color: #b71c1c;">
                        Bạn đã bị loại khỏi trò chơi
                    </div>
                </div>
                
                <button onclick="playerLogout()" style="margin-top: 20px;">Đăng xuất</button>
                
                <!-- Phần bỏ phiếu cho người chơi -->
                <div id="playerVotingContainer" class="voting-container">
                    <h3>Bỏ phiếu loại người chơi</h3>
                    <div id="playerVotingStatus" class="voting-status inactive">
                        Hiện không có phiên bỏ phiếu nào đang diễn ra
                    </div>
                    <div id="playerVotingTimer" class="voting-timer hidden">
                        Thời gian còn lại: <span id="playerCountdown" class="countdown">00:00</span>
                    </div>
                    <div id="playerVotingOptions" class="voting-options"></div>
                    <div id="playerVoteConfirmation" class="hidden status-bar">
                        Bạn đã bỏ phiếu cho: <span id="playerVoteChoice"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần quản trò xem vai trò -->
        <div id="adminContainer" class="hidden section">
            <h2>Quản lý vai trò</h2>
            <div id="adminSearchArea">
                <input type="text" id="adminGameCode" placeholder="Nhập mã phòng để xem">
                <button onclick="viewRoles()">Xem vai trò</button>
            </div>
            <div id="adminGameInfo" class="hidden">
                <div class="status-bar">
                    Đang xem phòng: <span id="adminCurrentRoom" class="room-code"></span>
                </div>
                <div id="adminStatus" class="status-bar">
                    Số người chơi: <span id="adminCurrentPlayers">0</span>/<span id="adminTotalPlayers">0</span>
                </div>
                <div id="roleTableContainer"></div>
                
                <!-- Nút bắt đầu lại game và cập nhật vai trò từ Google Sheets -->
                <div class="btn-group" style="margin-top: 20px;">
                    <button onclick="refreshGameWithSheetsData()" class="secondary">Cập nhật từ Google Sheets</button>
                </div>
                
                <!-- Phần quản lý bỏ phiếu cho quản trò -->
                <div id="votingContainer" class="voting-container">
                    <h3>Quản lý bỏ phiếu</h3>
                    <div id="votingStatus" class="voting-status inactive">
                        Chưa bắt đầu phiên bỏ phiếu nào
                    </div>
                    
                    <div id="votingControls">
                        <div class="input-group">
                            <label for="votingDuration">Thời gian bỏ phiếu (giây):</label>
                            <input type="number" id="votingDuration" value="60" min="10" max="300">
                        </div>
                        <button id="startVotingBtn" onclick="startVoting()" class="voting">Bắt đầu bỏ phiếu</button>
                        <button id="endVotingBtn" onclick="endVoting()" class="delete hidden">Kết thúc bỏ phiếu ngay</button>
                    </div>
                    
                    <div id="votingTimer" class="voting-timer hidden">
                        Thời gian còn lại: <span id="countdown" class="countdown">00:00</span>
                    </div>
                    
                    <div id="votingResults" class="voting-results hidden">
                        <h3>Kết quả bỏ phiếu</h3>
                        <div id="votingResultsList"></div>
                    </div>
                </div>
                
                <!-- THÊM PHẦN GHI CHÚ HÀNH ĐỘNG QUA ĐÊM -->
                <div id="gameNotesContainer" class="game-notes-container">
                    <h3>Ghi Chú Hành Động Các Đêm</h3>
                    
                    <div id="nightTabs" class="night-tabs">
                        <!-- Các tab đêm sẽ được tạo động -->
                        <button class="add-night-btn" onclick="addNewNight()">+ Thêm đêm</button>
                    </div>
                    
                    <div id="nightsContent">
                        <!-- Nội dung ghi chú từng đêm sẽ được tạo động -->
                    </div>
                </div>
                
                <button onclick="deleteCurrentRoom()" class="delete">Xóa phòng</button>
            </div>
        </div>
        
        <div class="footer">
            <p>Ma Sói © 2025 | Phiên bản 2.0</p>
            <p id="switchRole" class="hidden">
                <a href="#" onclick="switchUserRole()">Chuyển đổi vai trò</a>
            </p>
        </div>
    </div>

    <script>
        // Cấu hình Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAYUuNxsYWI59ahvjKHZujKyTfi95DzNwU",
            authDomain: "mywolf-game.firebaseapp.com",
            databaseURL: "https://mywolf-game-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mywolf-game",
            storageBucket: "mywolf-game.firebasestorage.app",
            messagingSenderId: "1099375631706",
            appId: "1:1099375631706:web:a1f6ccbcf71b7176046763"
        };
        
        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // Cấu hình Google Sheets
        // Link xuất bản từ Google Sheets
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSX4CcsBLZeHbEO2Ykp_FdiwmreveneNzZOFsfwRA3I8QfeKQw_i14akefo5EnTvRAT1XtzKYfJYNQJ/pub?gid=2087787635&single=true&output=csv";
        
        // Các biến toàn cục
        let currentGameCode = '';
        let playersListener = null;
        let votingListener = null;
        let gameRestartListener = null;
        let countdownInterval = null;
        let playerName = '';
        let playerDisplayName = '';
        let isGameMaster = false;
        const MASTER_PASSWORD = 'trungdepqua';
        let currentNightTab = 1;
        let deviceId = '';
        let confirmCallback = null;
        let playerIsDead = false;
        let sheetsData = []; // Lưu trữ dữ liệu từ Google Sheets
        
        // Khi trang đã tải xong
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Khởi tạo ứng dụng
        async function initApp() {
            // Tạo hoặc lấy deviceId
            deviceId = getOrCreateDeviceId();
            
            // Kiểm tra xem có vai trò đã lưu trong localStorage không
            const savedRole = localStorage.getItem('userRole');
            
            if (savedRole === 'gameMaster') {
                // Nếu đã là quản trò, kiểm tra xem đã xác thực chưa
                const isAuthenticated = localStorage.getItem('authenticated') === 'true';
                
                if (isAuthenticated) {
                    activateGameMasterUI();
                } else {
                    showRoleSelection();
                }
            } else if (savedRole === 'player') {
                activatePlayerUI();
            } else {
                showRoleSelection();
            }
            
            // Hiển thị nút chuyển đổi vai trò
            document.getElementById('switchRole').classList.remove('hidden');
            
            // Tải dữ liệu Google Sheets nếu là quản trò
            if (isGameMaster) {
                await fetchSheetsData();
            }
        }
        
        // Tải dữ liệu từ Google Sheets
        async function fetchSheetsData() {
            try {
                document.getElementById('sheetsStatus').innerHTML = `
                    <div class="loader"></div>
                    <p>Đang tải dữ liệu từ Google Sheets...</p>
                `;
                
                // Tải dữ liệu từ Google Sheets
                const response = await fetch(SHEET_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const csvData = await response.text();
                
                // Parse CSV sử dụng PapaParse
                const parsed = Papa.parse(csvData, { header: true });
                
                if (parsed.errors.length > 0) {
                    throw new Error('Lỗi parse CSV: ' + parsed.errors[0].message);
                }
                
                // Lọc dữ liệu hợp lệ
                sheetsData = parsed.data.filter(row => row['A'] && row['B'] && row['D']);
                
                document.getElementById('sheetsStatus').innerHTML = `
                    <p style="color: green;">✅ Dữ liệu đã được tải thành công!</p>
                    <p>Số người chơi: ${sheetsData.length}</p>
                    <p>Cập nhật lần cuối: ${new Date().toLocaleString()}</p>
                `;
                
                console.log('Sheet data loaded:', sheetsData);
                
                // Hiển thị nút tạo game nếu có dữ liệu
                if (sheetsData.length > 0) {
                    document.getElementById('createGameBtn').disabled = false;
                }
                
                return sheetsData;
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu từ Google Sheets:', error);
                document.getElementById('sheetsStatus').innerHTML = `
                    <p style="color: red;">❌ Lỗi khi tải dữ liệu!</p>
                    <p>${error.message}</p>
                    <p>Vui lòng kiểm tra cấu hình và thử lại.</p>
                `;
                return [];
            }
        }
        
        // Làm mới dữ liệu từ Google Sheets
        async function refreshSheetsData() {
            const data = await fetchSheetsData();
            if (data && data.length > 0) {
                alert(`Đã tải lại dữ liệu thành công! Số người chơi: ${data.length}`);
            }
        }
        
        // Làm mới game với dữ liệu mới từ Google Sheets
        async function refreshGameWithSheetsData() {
            if (!currentGameCode) {
                alert('Vui lòng chọn một phòng trước!');
                return;
            }
            
            showConfirmModal(
                'Cập nhật từ Google Sheets',
                'Bạn có chắc chắn muốn cập nhật danh sách người chơi và vai trò từ Google Sheets? Thông tin hiện tại sẽ bị ghi đè.',
                async function() {
                    try {
                        // Tải lại dữ liệu từ Google Sheets
                        const data = await fetchSheetsData();
                        
                        if (!data || data.length === 0) {
                            alert('Không thể tải dữ liệu từ Google Sheets!');
                            return;
                        }
                        
                        // Lấy thông tin phòng hiện tại
                        const gameRef = db.ref('games/' + currentGameCode);
                        const snapshot = await gameRef.once('value');
                        
                        if (!snapshot.exists()) {
                            alert('Phòng không tồn tại!');
                            return;
                        }
                        
                        const gameData = snapshot.val();
                        
                        // Tạo dữ liệu người chơi mới (giữ nguyên trạng thái dead/alive)
                        const newPlayers = {};
                        
                        // Tạo danh sách người chơi mới từ dữ liệu sheets
                        data.forEach(player => {
                            const loginName = player['B']; // Tên người chơi ở cột B
                            const role = player['D'];      // Vai trò ở cột D
                            
                            // Nếu người chơi đã tồn tại trong game, giữ nguyên trạng thái
                            if (gameData.players && gameData.players[loginName]) {
                                const existingPlayer = gameData.players[loginName];
                                
                                // Nếu là định dạng mới (có status)
                                if (typeof existingPlayer === 'object') {
                                    newPlayers[loginName] = {
                                        role: role,
                                        status: existingPlayer.status || 'alive'
                                    };
                                } else {
                                    // Định dạng cũ, chuyển sang định dạng mới
                                    newPlayers[loginName] = {
                                        role: role,
                                        status: 'alive'
                                    };
                                }
                            } else {
                                // Người chơi mới
                                newPlayers[loginName] = {
                                    role: role,
                                    status: 'alive'
                                };
                            }
                        });
                        
                        // Cập nhật thông tin phòng
                        await gameRef.update({
                            players: newPlayers,
                            playerCount: data.length,
                            lastUpdate: firebase.database.ServerValue.TIMESTAMP
                        });
                        
                        alert('Đã cập nhật thông tin người chơi thành công!');
                        
                    } catch (error) {
                        console.error('Lỗi khi cập nhật từ Google Sheets:', error);
                        alert('Đã xảy ra lỗi khi cập nhật từ Google Sheets!');
                    }
                }
            );
        }
        
        // Hàm tạo hoặc lấy ID thiết bị
        function getOrCreateDeviceId() {
            // Kiểm tra nếu đã có trong localStorage
            let id = localStorage.getItem('deviceId');
            if (!id) {
                // Tạo ID mới nếu chưa có
                id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('deviceId', id);
            }
            return id;
        }
        
        // Hiển thị màn hình lựa chọn vai trò
        function showRoleSelection() {
            hideAllContainers();
            document.getElementById('roleSelectionScreen').classList.remove('hidden');
        }
        
        // Chọn vai trò người dùng
        function selectUserRole(role) {
            if (role === 'player') {
                localStorage.setItem('userRole', 'player');
                activatePlayerUI();
            } else if (role === 'gameMaster') {
                showPasswordModal();
            }
        }
        
        // Hiển thị modal nhập mật khẩu
        function showPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('masterPassword').value = '';
            document.getElementById('passwordError').classList.add('hidden');
            
            // Tự động focus vào trường mật khẩu
            setTimeout(() => {
                document.getElementById('masterPassword').focus();
            }, 100);
            
            // Thêm listener cho phím Enter
            document.getElementById('masterPassword').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    verifyPassword();
                }
            });
        }
        
        // Hủy modal mật khẩu
        function cancelPasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
        }
        
        // Modal xác nhận
        function showConfirmModal(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            confirmCallback = callback;
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        }
        
        function handleConfirmYes() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }
        
        // Xác minh mật khẩu quản trò
        function verifyPassword() {
            const password = document.getElementById('masterPassword').value;
            
            if (password === MASTER_PASSWORD) {
                // Mật khẩu đúng
                localStorage.setItem('userRole', 'gameMaster');
                localStorage.setItem('authenticated', 'true');
                
                document.getElementById('passwordModal').classList.add('hidden');
                activateGameMasterUI();
            } else {
                // Mật khẩu sai
                document.getElementById('passwordError').classList.remove('hidden');
                document.getElementById('masterPassword').focus();
            }
        }
        
        // Chuyển đổi vai trò
        function switchUserRole() {
            // Xóa các trạng thái người dùng
            localStorage.removeItem('userRole');
            localStorage.removeItem('authenticated');
            localStorage.removeItem('playerName');
            localStorage.removeItem('playerRole');
            localStorage.removeItem('playerStatus');
            localStorage.removeItem('currentGame');
            
            // Ngừng lắng nghe Firebase nếu có
            if (playersListener) {
                playersListener.off();
                playersListener = null;
            }
            
            if (votingListener) {
                votingListener.off();
                votingListener = null;
            }
            
            if (gameRestartListener) {
                gameRestartListener.off();
                gameRestartListener = null;
            }
            
            // Hủy interval nếu có
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            // Hiển thị lại màn hình lựa chọn vai trò
            showRoleSelection();
        }
        
        // Ẩn tất cả các container
        function hideAllContainers() {
            document.getElementById('roleSelectionScreen').classList.add('hidden');
            document.getElementById('setupContainer').classList.add('hidden');
            document.getElementById('adminRoomsContainer').classList.add('hidden');
            document.getElementById('playerContainer').classList.add('hidden');
            document.getElementById('adminContainer').classList.add('hidden');
            document.getElementById('playerRoleView').classList.add('hidden');
        }
        
        // Kích hoạt giao diện quản trò
        async function activateGameMasterUI() {
            isGameMaster = true;
            hideAllContainers();
            
            document.getElementById('setupContainer').classList.remove('hidden');
            document.getElementById('adminRoomsContainer').classList.remove('hidden');
            document.getElementById('adminContainer').classList.remove('hidden');
            
            // Tải danh sách phòng cho quản trò
            loadRooms(true);
            
            // Tải dữ liệu từ Google Sheets
            await fetchSheetsData();
        }
        
        // Kích hoạt giao diện người chơi
        function activatePlayerUI() {
            isGameMaster = false;
            hideAllContainers();
            
            document.getElementById('playerContainer').classList.remove('hidden');
            
            // Kiểm tra xem người chơi đã đăng nhập chưa
            const savedLogin = localStorage.getItem('playerName');
            const savedRole = localStorage.getItem('playerRole');
            const savedStatus = localStorage.getItem('playerStatus');
            
            if (savedLogin && savedRole) {
                // Đã đăng nhập trước đó
                playerName = savedLogin;
                playerDisplayName = savedLogin;
                playerIsDead = savedStatus === 'dead';
                
                // Hiển thị thông tin người chơi
                document.getElementById('displayName').textContent = playerDisplayName;
                document.getElementById('role').textContent = savedRole;
                
                // Hiển thị trạng thái dead nếu cần
                if (playerIsDead) {
                    document.getElementById('roleResult').classList.add('dead');
                    document.getElementById('deadNotice').classList.remove('hidden');
                } else {
                    document.getElementById('roleResult').classList.remove('dead');
                    document.getElementById('deadNotice').classList.add('hidden');
                }
                
                // Hiển thị màn hình thông tin vai trò
                document.getElementById('playerRoleView').classList.remove('hidden');
                
                // Lắng nghe cập nhật vai trò và phiên bỏ phiếu
                const gameCode = localStorage.getItem('currentGame');
                if (gameCode) {
                    listenToGameUpdates(gameCode, playerName);
                }
            }
        }
        
        // Đăng nhập người chơi
        async function playerLogin() {
            const loginName = document.getElementById('playerLoginName').value.trim();
            const password = document.getElementById('playerPassword').value;
            
            if (!loginName) {
                showLoginStatus('Vui lòng nhập tên đăng nhập!', 'error');
                return;
            }
            
            try {
                showLoginStatus('Đang đăng nhập...');
                
                // Tải dữ liệu từ Google Sheets nếu chưa có
                if (!sheetsData || sheetsData.length === 0) {
                    sheetsData = await fetchSheetsData();
                }
                
                // Tìm thông tin người chơi trong dữ liệu Google Sheets
                const playerData = sheetsData.find(row => row['B'] === loginName);
                
                if (!playerData) {
                    showLoginStatus('Không tìm thấy tên đăng nhập!', 'error');
                    return;
                }
                
                // Kiểm tra mật khẩu từ cột A
                if (password !== playerData['A']) {
                    showLoginStatus('Mật khẩu không đúng!', 'error');
                    return;
                }
                
                // Tìm phòng game đang hoạt động
                const gamesRef = db.ref('games');
                const gamesSnapshot = await gamesRef.orderByChild('createdAt').limitToLast(1).once('value');
                
                if (!gamesSnapshot.exists()) {
                    showLoginStatus('Không có phòng nào đang hoạt động! Vui lòng đợi quản trò tạo phòng.', 'error');
                    return;
                }
                
                // Lấy thông tin phòng mới nhất
                let gameData = null;
                let gameCode = null;
                
                gamesSnapshot.forEach(childSnapshot => {
                    gameData = childSnapshot.val();
                    gameCode = childSnapshot.key;
                });
                
                if (!gameData || !gameCode) {
                    showLoginStatus('Không tìm thấy phòng hợp lệ!', 'error');
                    return;
                }
                
                // Lấy vai trò từ dữ liệu Google Sheets
                const role = playerData['D'];
                
                // Kiểm tra xem người chơi đã có trong phòng chưa
                let playerStatus = 'alive';
                if (gameData.players && gameData.players[loginName]) {
                    // Nếu người chơi đã tồn tại, giữ trạng thái
                    const existingPlayer = gameData.players[loginName];
                    if (typeof existingPlayer === 'object' && existingPlayer.status) {
                        playerStatus = existingPlayer.status;
                    }
                }
                
                // Cập nhật hoặc thêm người chơi vào phòng
                await db.ref(`games/${gameCode}/players/${loginName}`).set({
                    role: role,
                    status: playerStatus
                });
                
                // Lưu thông tin người chơi
                playerName = loginName;
                playerDisplayName = loginName;
                playerIsDead = playerStatus === 'dead';
                
                // Lưu vào localStorage
                localStorage.setItem('playerName', loginName);
                localStorage.setItem('playerRole', role);
                localStorage.setItem('playerStatus', playerStatus);
                localStorage.setItem('currentGame', gameCode);
                
                // Hiển thị thông tin người chơi
                document.getElementById('displayName').textContent = playerDisplayName;
                document.getElementById('role').textContent = role;
                
                // Hiển thị trạng thái dead nếu cần
                if (playerIsDead) {
                    document.getElementById('roleResult').classList.add('dead');
                    document.getElementById('deadNotice').classList.remove('hidden');
                } else {
                    document.getElementById('roleResult').classList.remove('dead');
                    document.getElementById('deadNotice').classList.add('hidden');
                }
                
                // Hiển thị màn hình thông tin vai trò
                document.getElementById('playerRoleView').classList.remove('hidden');
                
                // Ẩn form đăng nhập
                document.querySelector('.login-form').classList.add('hidden');
                
                // Lắng nghe cập nhật vai trò và phiên bỏ phiếu
                listenToGameUpdates(gameCode, loginName);
                
                showLoginStatus('Đăng nhập thành công!', 'success');
                
            } catch (error) {
                console.error('Lỗi khi đăng nhập:', error);
                showLoginStatus('Đã xảy ra lỗi khi đăng nhập!', 'error');
            }
        }
        
        // Đăng xuất người chơi
        function playerLogout() {
            localStorage.removeItem('playerName');
            localStorage.removeItem('playerRole');
            localStorage.removeItem('playerStatus');
            localStorage.removeItem('currentGame');
            
            // Ngừng lắng nghe cập nhật
            if (gameRestartListener) {
                gameRestartListener.off();
                gameRestartListener = null;
            }
            
            if (votingListener) {
                votingListener.off();
                votingListener = null;
            }
            
            // Hiển thị lại form đăng nhập
            document.querySelector('.login-form').classList.remove('hidden');
            document.getElementById('playerRoleView').classList.add('hidden');
            document.getElementById('playerLoginName').value = '';
            document.getElementById('playerPassword').value = '';
            document.getElementById('loginStatus').classList.add('hidden');
        }
        
        // Hiển thị thông báo đăng nhập
        function showLoginStatus(message, type = '') {
            const statusElement = document.getElementById('loginStatus');
            statusElement.textContent = message;
            
            // Đặt lại tất cả các lớp
            statusElement.className = 'status-bar';
            
            if (type === 'error') {
                statusElement.style.backgroundColor = '#ffebee';
                statusElement.style.color = '#c62828';
            } else if (type === 'success') {
                statusElement.style.backgroundColor = '#e8f5e9';
                statusElement.style.color = '#2e7d32';
            } else if (type === 'info') {
                statusElement.style.backgroundColor = '#e3f2fd';
                statusElement.style.color = '#0d47a1';
            } else {
                statusElement.style.backgroundColor = '#f0f0f0';
                statusElement.style.color = '#333';
            }
            
            statusElement.classList.remove('hidden');
        }
        
        // Lắng nghe cập nhật game cho người chơi
        function listenToGameUpdates(gameCode, loginName) {
            if (!gameCode || !loginName) return;
            
            // Lắng nghe cập nhật thông tin người chơi
            listenToPlayerUpdates(gameCode, loginName);
            
            // Lắng nghe phiên bỏ phiếu
            listenToVotingSession(gameCode);
        }
        
        // Lắng nghe cập nhật thông tin người chơi
        function listenToPlayerUpdates(gameCode, loginName) {
            // Ngừng lắng nghe cũ nếu có
            if (gameRestartListener) {
                gameRestartListener.off();
            }
            
            // Lắng nghe thay đổi trong thông tin người chơi
            gameRestartListener = db.ref(`games/${gameCode}/players/${loginName}`);
            gameRestartListener.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    // Người chơi đã bị xóa khỏi phòng
                    alert('Bạn đã bị đuổi khỏi phòng!');
                    playerLogout();
                    return;
                }
                
                const playerData = snapshot.val();
                
                // Xác định vai trò và trạng thái mới
                let newRole, newStatus;
                if (typeof playerData === 'object') {
                    newRole = playerData.role || 'Không xác định';
                    newStatus = playerData.status || 'alive';
                } else {
                    newRole = playerData;
                    newStatus = 'alive';
                }
                
                // Lấy giá trị hiện tại
                const oldRole = document.getElementById('role').textContent;
                const oldStatus = playerIsDead ? 'dead' : 'alive';
                
                // Nếu vai trò hoặc trạng thái đã thay đổi
                if (newRole !== oldRole || newStatus !== oldStatus) {
                    // Cập nhật vai trò trên giao diện
                    document.getElementById('role').textContent = newRole;
                    playerIsDead = newStatus === 'dead';
                    
                    // Cập nhật hiển thị trạng thái dead
                    if (playerIsDead) {
                        document.getElementById('roleResult').classList.add('dead');
                        document.getElementById('deadNotice').classList.remove('hidden');
                    } else {
                        document.getElementById('roleResult').classList.remove('dead');
                        document.getElementById('deadNotice').classList.add('hidden');
                    }
                    
                    // Lưu vào localStorage
                    localStorage.setItem('playerRole', newRole);
                    localStorage.setItem('playerStatus', newStatus);
                    
                    // Hiển thị thông báo phù hợp
                    if (newRole !== oldRole) {
                        // Nếu vai trò thay đổi
                        showLoginStatus(`Vai trò của bạn đã được cập nhật thành: ${newRole}`, 'success');
                        
                        // Thêm hiệu ứng để làm nổi bật thông báo
                        const roleResult = document.getElementById('roleResult');
                        roleResult.classList.add('role-flash');
                        setTimeout(() => {
                            roleResult.classList.remove('role-flash');
                        }, 3000);
                    }
                    
                    // Nếu trạng thái thay đổi từ alive sang dead
                    if (newStatus === 'dead' && oldStatus === 'alive') {
                        showLoginStatus('Bạn đã bị loại khỏi trò chơi!', 'error');
                    }
                    // Nếu trạng thái thay đổi từ dead sang alive
                    else if (newStatus === 'alive' && oldStatus === 'dead') {
                        showLoginStatus('Bạn đã được hồi sinh!', 'success');
                    }
                }
            });
        }

        // Hàm tạo trò chơi (quản trò)
        async function setupGame() {
            // Kiểm tra xem có dữ liệu từ Google Sheets không
            if (!sheetsData || sheetsData.length === 0) {
                showSetupStatus('Chưa có dữ liệu người chơi từ Google Sheets!', 'error');
                await fetchSheetsData();
                
                if (!sheetsData || sheetsData.length === 0) {
                    return;
                }
            }
            
            showSetupStatus('Đang tạo trò chơi...');
            
            try {
                // Tạo mã trò chơi độc đáo với thời gian
                let code = 'R' + Math.random().toString(36).substring(2, 6).toUpperCase() + 
                           new Date().getSeconds();
                
                // Chuẩn bị dữ liệu người chơi từ Google Sheets
                const players = {};
                sheetsData.forEach(row => {
                    const playerName = row['B'];
                    const role = row['D'];
                    
                    players[playerName] = {
                        role: role,
                        status: 'alive'
                    };
                });
                
                // Khởi tạo cấu trúc ghi chú với đêm đầu tiên
                const initialNotes = {
                    night1: {
                        content: '',
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }
                };
                
                // Khởi tạo cấu trúc bỏ phiếu
                const initialVoting = {
                    active: false,
                    endTime: 0,
                    duration: 60,
                    votes: {}
                };
                
                await db.ref('games/' + code).set({
                    playerCount: sheetsData.length,
                    players: players,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    nightNotes: initialNotes,
                    voting: initialVoting
                });
                
                document.getElementById('code').textContent = code;
                document.getElementById('gameCode').classList.remove('hidden');
                document.getElementById('adminGameCode').value = code;
                currentGameCode = code;
                
                // Tự động xem vai trò sau khi tạo
                viewRoles();
                
                // Cập nhật danh sách phòng
                loadRooms(true);
                
                showSetupStatus(`Trò chơi đã được tạo thành công với mã: ${code}`, 'success');
            } catch (error) {
                console.error('Lỗi khi tạo trò chơi:', error);
                showSetupStatus('Lỗi khi tạo trò chơi. Vui lòng thử lại!', 'error');
            }
        }
        
        // Hiển thị thông báo trạng thái thiết lập
        function showSetupStatus(message, type = '') {
            const statusElement = document.getElementById('setupStatus');
            statusElement.textContent = message;
            
            // Đặt lại tất cả các lớp
            statusElement.className = 'status-bar';
            
            if (type === 'error') {
                statusElement.style.backgroundColor = '#ffebee';
                statusElement.style.color = '#c62828';
            } else if (type === 'success') {
                statusElement.style.backgroundColor = '#e8f5e9';
                statusElement.style.color = '#2e7d32';
            } else {
                statusElement.style.backgroundColor = '#f0f0f0';
                statusElement.style.color = '#333';
            }
            
            statusElement.classList.remove('hidden');
        }

        // Hàm lấy danh sách phòng
        async function loadRooms(isAdmin) {
            const roomsContainer = isAdmin ? 
                document.getElementById('adminRoomsList') : 
                document.getElementById('playerRoomsList');
            
            roomsContainer.innerHTML = '<p>Đang tải danh sách phòng...</p>';
            
            try {
                const gamesRef = db.ref('games');
                const snapshot = await gamesRef.once('value');
                
                if (!snapshot.exists()) {
                    roomsContainer.innerHTML = '<p>Không có phòng nào.</p>';
                    return;
                }
                
                let games = snapshot.val();
                let roomCount = 0;
                
                // Sắp xếp phòng theo thời gian tạo (gần nhất đầu tiên)
                const sortedRooms = Object.entries(games)
                    .sort(([,a], [,b]) => (b.createdAt || 0) - (a.createdAt || 0));
                
                roomsContainer.innerHTML = '';
                
                for (let [code, game] of sortedRooms) {
                    roomCount++;
                    let playerCount = game.playerCount || 0;
                    let currentCount = game.players ? Object.keys(game.players).length : 0;
                    
                    let roomItem = document.createElement('div');
                    roomItem.className = 'room-item';
                    
                    // Thêm thông tin bỏ phiếu nếu có
                    let votingStatus = '';
                    if (game.voting && game.voting.active) {
                        votingStatus = ' <span style="color: var(--voting-color);">[Đang bỏ phiếu]</span>';
                    }
                    
                    let roomInfo = document.createElement('div');
                    roomInfo.className = 'room-info';
                    roomInfo.innerHTML = `
                        <div>Phòng: <span class="room-code">${code}</span>${votingStatus}</div>
                        <div>Số người chơi: ${currentCount}/${playerCount}</div>
                        <div>Tạo lúc: ${new Date(game.createdAt).toLocaleString()}</div>
                    `;
                    
                    let roomActions = document.createElement('div');
                    roomActions.className = 'room-actions';
                    
                    if (isAdmin) {
                        // Actions cho quản trò
                        let viewButton = document.createElement('button');
                        viewButton.innerText = 'Xem';
                        viewButton.onclick = function() { viewRoles(code); };
                        
                        let deleteButton = document.createElement('button');
                        deleteButton.innerText = 'Xóa';
                        deleteButton.className = 'delete';
                        deleteButton.onclick = function() { deleteRoom(code); };
                        
                        roomActions.appendChild(viewButton);
                        roomActions.appendChild(deleteButton);
                    }
                    
                    roomItem.appendChild(roomInfo);
                    roomItem.appendChild(roomActions);
                    roomsContainer.appendChild(roomItem);
                }
                
            } catch (error) {
                console.error('Lỗi khi tải danh sách phòng:', error);
                roomsContainer.innerHTML = '<p>Đã xảy ra lỗi khi tải danh sách phòng. Vui lòng thử lại.</p>';
            }
        }

        // Hàm xem vai trò (quản trò)
        function viewRoles(code) {
            let gameCode = code || document.getElementById('adminGameCode').value.toUpperCase();
            
            if (!gameCode) {
                alert('Vui lòng nhập hoặc chọn một phòng!');
                return;
            }
            
            currentGameCode = gameCode;
            document.getElementById('adminCurrentRoom').textContent = gameCode;
            document.getElementById('adminGameInfo').classList.remove('hidden');
            
            // Ngừng lắng nghe trước đó nếu có
            if (playersListener) {
                playersListener.off();
            }
            
            // Bắt đầu lắng nghe thay đổi trong phòng
            playersListener = db.ref('games/' + gameCode);
            playersListener.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    let gameData = snapshot.val();
                    updateAdminView(gameData);
                    loadNightNotes(gameData);
                    loadVotingData(gameData);
                } else {
                    alert('Phòng không tồn tại hoặc đã bị xóa!');
                    document.getElementById('adminGameInfo').classList.add('hidden');
                }
            });
        }

        // Hàm cập nhật giao diện quản trò
        function updateAdminView(game) {
            let playerCount = game.playerCount || 0;
            let currentCount = game.players ? Object.keys(game.players).length : 0;
            
            document.getElementById('adminCurrentPlayers').textContent = currentCount;
            document.getElementById('adminTotalPlayers').textContent = playerCount;
            
            // Thay đổi màu dựa trên tỷ lệ
            let statusBar = document.getElementById('adminStatus');
            if (currentCount == playerCount) {
                statusBar.className = 'status-bar full';
            } else if (currentCount == 0) {
                statusBar.className = 'status-bar empty';
            } else {
                statusBar.className = 'status-bar';
            }
            
            // Hiển thị vai trò dưới dạng bảng
            const tableContainer = document.getElementById('roleTableContainer');
            
            if (!game.players || Object.keys(game.players).length === 0) {
                tableContainer.innerHTML = '<p>Chưa có người chơi nào tham gia.</p>';
                return;
            }
            
            // Tạo bảng HTML
            let tableHTML = `
                <table class="role-table">
                    <thead>
                        <tr>
                            <th>Tên người chơi</th>
                            <th>Vai trò</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Thêm dữ liệu người chơi
            Object.entries(game.players).forEach(([player, playerData]) => {
                // Lấy thông tin vai trò và trạng thái
                let role, status;
                if (typeof playerData === 'object') {
                    role = playerData.role || 'Không xác định';
                    status = playerData.status || 'alive';
                } else {
                    role = playerData;
                    status = 'alive';
                }
                
                // Xác định các lớp CSS dựa trên trạng thái
                const rowClass = status === 'dead' ? 'dead' : '';
                const statusText = status === 'dead' ? 'Đã chết' : 'Còn sống';
                const statusClass = status === 'dead' ? 'dead-status' : '';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${player}</td>
                        <td>${role}</td>
                        <td>
                            <span class="player-status ${statusClass}">${statusText}</span>
                        </td>
                        <td>
                            <div class="player-actions">
                                ${status === 'alive' ? 
                                    `<button class="icon delete" title="Đánh dấu đã chết" onclick="togglePlayerStatus('${player}', 'dead')">☠️</button>` : 
                                    `<button class="icon" title="Đánh dấu còn sống" onclick="togglePlayerStatus('${player}', 'alive')">❤️</button>`
                                }
                                <button class="icon warning" title="Đuổi khỏi phòng" onclick="kickPlayer('${player}')">🚫</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
        }
        
        // Hàm đánh dấu người chơi đã chết/còn sống
        async function togglePlayerStatus(playerName, newStatus) {
            if (!currentGameCode || !playerName) {
                alert('Không có thông tin người chơi!');
                return;
            }
            
            const action = newStatus === 'dead' ? 'đã chết' : 'còn sống';
            
            showConfirmModal(
                'Cập nhật trạng thái người chơi',
                `Bạn có chắc chắn muốn đánh dấu "${playerName}" là ${action}?`,
                async function() {
                    try {
                        const playerRef = db.ref(`games/${currentGameCode}/players/${playerName}`);
                        const snapshot = await playerRef.once('value');
                        
                        if (!snapshot.exists()) {
                            alert('Không tìm thấy người chơi này!');
                            return;
                        }
                        
                        const playerData = snapshot.val();
                        
                        // Cập nhật trạng thái người chơi
                        if (typeof playerData === 'object') {
                            // Đã là định dạng mới, chỉ cập nhật trạng thái
                            await playerRef.update({ status: newStatus });
                        } else {
                            // Định dạng cũ, cập nhật lên cấu trúc mới
                            await playerRef.set({
                                role: playerData,
                                status: newStatus
                            });
                        }
                        
                        alert(`Đã cập nhật trạng thái của "${playerName}" thành ${action}.`);
                        
                    } catch (error) {
                        console.error('Lỗi khi cập nhật trạng thái người chơi:', error);
                        alert('Đã xảy ra lỗi khi cập nhật trạng thái người chơi!');
                    }
                }
            );
        }
        
        // Hàm đuổi người chơi khỏi phòng
        async function kickPlayer(playerName) {
            if (!currentGameCode || !playerName) {
                alert('Không có thông tin người chơi!');
                return;
            }
            
            showConfirmModal(
                'Đuổi người chơi',
                `Bạn có chắc chắn muốn đuổi "${playerName}" khỏi phòng?`,
                async function() {
                    try {
                        await db.ref(`games/${currentGameCode}/players/${playerName}`).remove();
                        alert(`Đã đuổi "${playerName}" khỏi phòng thành công.`);
                    } catch (error) {
                        console.error('Lỗi khi đuổi người chơi:', error);
                        alert('Đã xảy ra lỗi khi đuổi người chơi!');
                    }
                }
            );
        }

        // Hàm tải dữ liệu bỏ phiếu cho quản trò
        function loadVotingData(gameData) {
            const votingData = gameData.voting || {
                active: false,
                endTime: 0,
                duration: 60,
                votes: {}
            };
            
            // Cập nhật trạng thái hiển thị
            const votingStatus = document.getElementById('votingStatus');
            const startVotingBtn = document.getElementById('startVotingBtn');
            const endVotingBtn = document.getElementById('endVotingBtn');
            const votingTimer = document.getElementById('votingTimer');
            const votingResults = document.getElementById('votingResults');
            
            // Nếu phiên bỏ phiếu đang diễn ra
            if (votingData.active) {
                votingStatus.textContent = 'Đang diễn ra phiên bỏ phiếu';
                votingStatus.className = 'voting-status active';
                
                startVotingBtn.classList.add('hidden');
                endVotingBtn.classList.remove('hidden');
                votingTimer.classList.remove('hidden');
                
                // Cập nhật thời gian đếm ngược
                updateCountdown(votingData.endTime);
                
            } else {
                votingStatus.textContent = 'Không có phiên bỏ phiếu nào đang diễn ra';
                votingStatus.className = 'voting-status inactive';
                
                startVotingBtn.classList.remove('hidden');
                endVotingBtn.classList.add('hidden');
                votingTimer.classList.add('hidden');
                
                // Hủy đếm ngược nếu có
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                
                // Hiển thị kết quả bỏ phiếu nếu có
                if (votingData.votes && Object.keys(votingData.votes).length > 0) {
                    displayVotingResults(votingData.votes, gameData.players);
                } else {
                    votingResults.classList.add('hidden');
                }
            }
            
            // Cập nhật thời lượng bỏ phiếu
            document.getElementById('votingDuration').value = votingData.duration || 60;
        }
        
        // Hàm bắt đầu phiên bỏ phiếu mới
        async function startVoting() {
            if (!currentGameCode) {
                alert('Vui lòng chọn một phòng trước!');
                return;
            }
            
            // Kiểm tra số người chơi
            const snapshot = await db.ref('games/' + currentGameCode + '/players').once('value');
            if (!snapshot.exists() || Object.keys(snapshot.val()).length < 2) {
                alert('Cần ít nhất 2 người chơi để bắt đầu bỏ phiếu!');
                return;
            }
            
            // Lấy thời lượng từ trường nhập
            const duration = parseInt(document.getElementById('votingDuration').value) || 60;
            if (isNaN(duration) || duration < 10 || duration > 300) {
                alert('Thời gian bỏ phiếu phải từ 10 đến 300 giây!');
                return;
            }
            
            // Tính thời gian kết thúc
            const now = Date.now();
            const endTime = now + (duration * 1000);
            
            // Cập nhật dữ liệu bỏ phiếu trong Firebase
            try {
                await db.ref('games/' + currentGameCode + '/voting').update({
                    active: true,
                    startTime: now,
                    endTime: endTime,
                    duration: duration,
                    votes: {} // Xóa các phiếu bầu cũ nếu có
                });
                
                // Cập nhật giao diện
                document.getElementById('votingStatus').textContent = 'Đang diễn ra phiên bỏ phiếu';
                document.getElementById('votingStatus').className = 'voting-status active';
                document.getElementById('startVotingBtn').classList.add('hidden');
                document.getElementById('endVotingBtn').classList.remove('hidden');
                document.getElementById('votingTimer').classList.remove('hidden');
                document.getElementById('votingResults').classList.add('hidden');
                
                // Bắt đầu đếm ngược
                updateCountdown(endTime);
                
                // Tự động kết thúc khi hết thời gian
                setTimeout(() => {
                    if (currentGameCode) {
                        db.ref('games/' + currentGameCode + '/voting/active').once('value', (snapshot) => {
                            if (snapshot.exists() && snapshot.val() === true) {
                                endVoting();
                            }
                        });
                    }
                }, duration * 1000 + 1000); // Thêm 1 giây dư phòng
                
            } catch (error) {
                console.error('Lỗi khi bắt đầu phiên bỏ phiếu:', error);
                alert('Đã xảy ra lỗi khi bắt đầu phiên bỏ phiếu!');
            }
        }
        
        // Hàm kết thúc phiên bỏ phiếu hiện tại
        async function endVoting() {
            if (!currentGameCode) {
                alert('Không có phòng nào được chọn!');
                return;
            }
            
            try {
                // Cập nhật trạng thái bỏ phiếu
                await db.ref('games/' + currentGameCode + '/voting').update({
                    active: false,
                    endTime: Date.now()
                });
                
                // Cập nhật giao diện
                document.getElementById('votingStatus').textContent = 'Phiên bỏ phiếu đã kết thúc';
                document.getElementById('votingStatus').className = 'voting-status completed';
                document.getElementById('startVotingBtn').classList.remove('hidden');
                document.getElementById('endVotingBtn').classList.add('hidden');
                document.getElementById('votingTimer').classList.add('hidden');
                
                // Hủy đếm ngược nếu có
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                
                // Hiển thị kết quả bỏ phiếu
                const snapshot = await db.ref('games/' + currentGameCode + '/voting/votes').once('value');
                const votes = snapshot.val() || {};
                
                const playersSnapshot = await db.ref('games/' + currentGameCode + '/players').once('value');
                const players = playersSnapshot.val() || {};
                
                displayVotingResults(votes, players);
                
            } catch (error) {
                console.error('Lỗi khi kết thúc phiên bỏ phiếu:', error);
                alert('Đã xảy ra lỗi khi kết thúc phiên bỏ phiếu!');
            }
        }
        
        // Hiển thị kết quả bỏ phiếu
        function displayVotingResults(votes, players) {
            const resultsContainer = document.getElementById('votingResults');
            const resultsList = document.getElementById('votingResultsList');
            
            // Đếm số phiếu cho mỗi người chơi
            const voteCounts = {};
            let totalVotes = 0;
            
            // Khởi tạo số phiếu cho tất cả người chơi còn sống bằng 0
            Object.entries(players).forEach(([playerName, playerData]) => {
                // Chỉ đếm những người chơi còn sống
                const status = typeof playerData === 'object' ? (playerData.status || 'alive') : 'alive';
                if (status !== 'dead') {
                    voteCounts[playerName] = 0;
                }
            });
            
            // Đếm số phiếu
            Object.entries(votes).forEach(([voter, votedFor]) => {
                if (voteCounts.hasOwnProperty(votedFor)) {
                    voteCounts[votedFor]++;
                    totalVotes++;
                }
            });
            
            // Sắp xếp người chơi theo số phiếu nhận được (cao đến thấp)
            const sortedPlayers = Object.keys(voteCounts).sort((a, b) => {
                return voteCounts[b] - voteCounts[a];
            });
            
            // Tìm người có số phiếu cao nhất
            let highestVotes = 0;
            let winners = [];
            
            sortedPlayers.forEach(player => {
                const votes = voteCounts[player];
                if (votes > 0) {
                    if (votes > highestVotes) {
                        highestVotes = votes;
                        winners = [player];
                    } else if (votes === highestVotes) {
                        winners.push(player);
                    }
                }
            });
            
            // Hiển thị kết quả
            resultsContainer.classList.remove('hidden');
            resultsList.innerHTML = '';
            
            if (totalVotes === 0) {
                resultsList.innerHTML = '<p>Không có ai bỏ phiếu.</p>';
                return;
            }
            
            // Hiển thị kết quả của từng người chơi
            sortedPlayers.forEach(player => {
                if (voteCounts[player] > 0) {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'voting-result-item';
                    
                    // Đánh dấu người thắng
                    if (winners.includes(player)) {
                        resultItem.classList.add('voting-result-winner');
                    }
                    
                    resultItem.innerHTML = `
                        <span>${player}</span>
                        <span>${voteCounts[player]} phiếu</span>
                    `;
                    resultsList.appendChild(resultItem);
                }
            });
            
            // Hiển thị kết luận
            let conclusion = document.createElement('p');
            conclusion.style.marginTop = '15px';
            conclusion.style.fontWeight = 'bold';
            
            if (winners.length === 0) {
                conclusion.textContent = 'Không có ai bị loại.';
            } else if (winners.length === 1) {
                conclusion.textContent = `${winners[0]} bị loại với ${highestVotes} phiếu.`;
            } else {
                conclusion.textContent = `Có ${winners.length} người cùng có số phiếu cao nhất (${highestVotes}): ${winners.join(', ')}.`;
            }
            
            resultsList.appendChild(conclusion);
            
            // Thêm nút đánh dấu người chơi đã chết
            if (winners.length > 0) {
                const markDeadSection = document.createElement('div');
                markDeadSection.style.marginTop = '20px';
                markDeadSection.style.borderTop = '1px solid #ddd';
                markDeadSection.style.paddingTop = '15px';
                
                const heading = document.createElement('h3');
                heading.textContent = 'Đánh dấu người chơi đã chết';
                
                markDeadSection.appendChild(heading);
                
                winners.forEach(player => {
                    const markButton = document.createElement('button');
                    markButton.className = 'delete';
                    markButton.style.marginTop = '10px';
                    markButton.textContent = `Đánh dấu "${player}" đã chết`;
                    markButton.onclick = function() {
                        togglePlayerStatus(player, 'dead');
                    };
                    markDeadSection.appendChild(markButton);
                });
                
                resultsList.appendChild(markDeadSection);
            }
        }
        
        // Cập nhật đếm ngược thời gian bỏ phiếu
        function updateCountdown(endTime) {
            // Xóa interval cũ nếu có
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            // Hàm cập nhật hiển thị thời gian còn lại
            function updateTimer() {
                const now = Date.now();
                const timeLeft = Math.max(0, endTime - now);
                
                if (timeLeft <= 0) {
                    // Hết thời gian
                    document.getElementById('countdown').textContent = '00:00';
                    if (!isGameMaster) {
                        document.getElementById('playerCountdown').textContent = '00:00';
                    }
                    
                    clearInterval(countdownInterval);
                    return;
                }
                
                // Định dạng thời gian mm:ss
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                const formattedTime = 
                    (minutes < 10 ? '0' : '') + minutes + ':' + 
                    (seconds < 10 ? '0' : '') + seconds;
                
                // Cập nhật hiển thị
                document.getElementById('countdown').textContent = formattedTime;
                if (!isGameMaster) {
                    document.getElementById('playerCountdown').textContent = formattedTime;
                }
            }
            
            // Cập nhật ngay lập tức
            updateTimer();
            
            // Cập nhật mỗi giây
            countdownInterval = setInterval(updateTimer, 1000);
        }
        
        // Lắng nghe phiên bỏ phiếu cho người chơi
        function listenToVotingSession(gameCode) {
            if (!gameCode || !playerName) return;
            
            // Ngừng lắng nghe trước đó nếu có
            if (votingListener) {
                votingListener.off();
            }
            
            // Lắng nghe thay đổi trạng thái bỏ phiếu
            votingListener = db.ref('games/' + gameCode + '/voting');
            votingListener.on('value', (snapshot) => {
                if (!snapshot.exists()) return;
                
                const votingData = snapshot.val();
                const votingStatus = document.getElementById('playerVotingStatus');
                const votingTimer = document.getElementById('playerVotingTimer');
                const votingOptions = document.getElementById('playerVotingOptions');
                const voteConfirmation = document.getElementById('playerVoteConfirmation');
                
                // Nếu phiên bỏ phiếu đang diễn ra và người chơi còn sống
                if (votingData.active && !playerIsDead) {
                    // Cập nhật trạng thái
                    votingStatus.textContent = 'Phiên bỏ phiếu đang diễn ra!';
                    votingStatus.className = 'voting-status active';
                    votingTimer.classList.remove('hidden');
                    
                    // Cập nhật đếm ngược
                    updateCountdown(votingData.endTime);
                    
                    // Tải danh sách người chơi để bỏ phiếu
                    loadVotingOptions(gameCode, votingData.votes || {});
                    
                } else if (votingData.active && playerIsDead) {
                    // Người chơi đã chết nhưng phiên bỏ phiếu đang diễn ra
                    votingStatus.textContent = 'Bạn không thể bỏ phiếu vì đã bị loại khỏi trò chơi';
                    votingStatus.className = 'voting-status inactive';
                    votingTimer.classList.add('hidden');
                    votingOptions.innerHTML = '';
                    voteConfirmation.classList.add('hidden');
                    
                } else {
                    // Phiên bỏ phiếu đã kết thúc hoặc chưa bắt đầu
                    votingStatus.textContent = 'Hiện không có phiên bỏ phiếu nào đang diễn ra';
                    votingStatus.className = 'voting-status inactive';
                    votingTimer.classList.add('hidden');
                    votingOptions.innerHTML = '';
                    voteConfirmation.classList.add('hidden');
                    
                    // Hủy đếm ngược nếu có
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                }
            });
        }
        
        // Tải danh sách người chơi cho phiên bỏ phiếu
        async function loadVotingOptions(gameCode, currentVotes) {
            if (!gameCode || !playerName || playerIsDead) return;
            
            try {
                // Lấy danh sách người chơi
                const snapshot = await db.ref('games/' + gameCode + '/players').once('value');
                if (!snapshot.exists()) return;
                
                const allPlayers = snapshot.val();
                const votingOptions = document.getElementById('playerVotingOptions');
                votingOptions.innerHTML = '';
                
                // Kiểm tra xem người chơi hiện tại đã bỏ phiếu chưa
                const myVote = currentVotes[playerName];
                
                // Nếu đã bỏ phiếu, hiển thị xác nhận
                if (myVote) {
                    document.getElementById('playerVoteChoice').textContent = myVote;
                    document.getElementById('playerVoteConfirmation').classList.remove('hidden');
                } else {
                    document.getElementById('playerVoteConfirmation').classList.add('hidden');
                }
                
                // Tạo danh sách người chơi còn sống để bỏ phiếu (loại trừ người chơi hiện tại)
                Object.entries(allPlayers).forEach(([name, playerData]) => {
                    // Xác định trạng thái người chơi
                    let status = 'alive';
                    if (typeof playerData === 'object' && playerData.status) {
                        status = playerData.status;
                    }
                    
                    // Chỉ hiển thị người chơi còn sống và không phải bản thân
                    if (name !== playerName && status !== 'dead') {
                        const option = document.createElement('div');
                        option.className = 'vote-option';
                        
                        // Đánh dấu lựa chọn đã chọn
                        if (name === myVote) {
                            option.classList.add('selected');
                        }
                        
                        option.innerHTML = `<span>${name}</span>`;
                        option.onclick = function() {
                            submitVote(gameCode, name);
                        };
                        
                        votingOptions.appendChild(option);
                    }
                });
                
                // Hiển thị thông báo nếu không còn ai để bỏ phiếu
                if (votingOptions.children.length === 0) {
                    votingOptions.innerHTML = '<p>Không có người chơi nào để bỏ phiếu.</p>';
                }
                
            } catch (error) {
                console.error('Lỗi khi tải lựa chọn bỏ phiếu:', error);
            }
        }
        
        // Hàm bỏ phiếu
        async function submitVote(gameCode, votedFor) {
            if (!gameCode || !playerName || !votedFor || playerIsDead) return;
            
            try {
                // Kiểm tra xem phiên bỏ phiếu có còn diễn ra không
                const snapshot = await db.ref('games/' + gameCode + '/voting/active').once('value');
                if (!snapshot.exists() || snapshot.val() !== true) {
                    alert('Phiên bỏ phiếu đã kết thúc!');
                    return;
                }
                
                // Cập nhật phiếu bầu vào database
                await db.ref('games/' + gameCode + '/voting/votes/' + playerName).set(votedFor);
                
                // Cập nhật UI
                document.getElementById('playerVoteChoice').textContent = votedFor;
                document.getElementById('playerVoteConfirmation').classList.remove('hidden');
                
                // Cập nhật trạng thái lựa chọn
                const options = document.querySelectorAll('.vote-option');
                options.forEach(option => {
                    const name = option.querySelector('span').textContent;
                    if (name === votedFor) {
                        option.classList.add('selected');
                    } else {
                        option.classList.remove('selected');
                    }
                });
                
            } catch (error) {
                console.error('Lỗi khi bỏ phiếu:', error);
                alert('Đã xảy ra lỗi khi bỏ phiếu. Vui lòng thử lại!');
            }
        }

        // HÀM XỬ LÝ GHI CHÚ ĐÊM //
        
        // Tải ghi chú đêm
        function loadNightNotes(gameData) {
            // Khởi tạo nightNotes nếu chưa có
            if (!gameData.nightNotes) {
                // Tạo ghi chú đêm đầu tiên
                db.ref('games/' + currentGameCode + '/nightNotes').set({
                    night1: {
                        content: '',
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }
                });
                
                currentNightTab = 1;
                renderNightTabs(1);
                renderNightContent(1, '');
            } else {
                // Hiển thị các ghi chú đã có
                const nightNotes = gameData.nightNotes;
                const nightNumbers = Object.keys(nightNotes)
                    .map(key => parseInt(key.replace('night', '')))
                    .sort((a, b) => a - b);
                
                // Mặc định chọn đêm cuối cùng
                currentNightTab = nightNumbers[nightNumbers.length - 1] || 1;
                
                renderNightTabs(nightNumbers.length);
                
                // Hiển thị nội dung của đêm hiện tại
                const currentNightKey = 'night' + currentNightTab;
                const currentNoteContent = nightNotes[currentNightKey] ? nightNotes[currentNightKey].content : '';
                renderNightContent(currentNightTab, currentNoteContent);
            }
        }
        
        // Tạo các tab đêm
        function renderNightTabs(numNights) {
            const tabsContainer = document.getElementById('nightTabs');
            
            // Xóa các tab cũ trừ nút thêm đêm mới
            const addNightBtn = tabsContainer.querySelector('.add-night-btn');
            tabsContainer.innerHTML = '';
            
            // Thêm lại các tab mới
            for (let i = 1; i <= numNights; i++) {
                const tab = document.createElement('button');
                tab.textContent = `Đêm ${i}`;
                tab.className = 'night-tab';
                tab.dataset.night = i;
                if (i === currentNightTab) {
                    tab.classList.add('active');
                }
                
                tab.onclick = function() {
                    switchNightTab(i);
                };
                
                tabsContainer.appendChild(tab);
            }
            
            // Thêm lại nút thêm đêm mới
            tabsContainer.appendChild(addNightBtn || document.createElement('button'));
        }
        
        // Hiển thị nội dung đêm
        function renderNightContent(nightNum, content) {
            const nightsContent = document.getElementById('nightsContent');
            
            // Tạo giao diện cho nội dung đêm
            nightsContent.innerHTML = `
                <div class="night-content">
                    <h3>Ghi chú Đêm ${nightNum}</h3>
                    <textarea id="nightNote" placeholder="Ghi chú các hành động trong đêm...">${content}</textarea>
                    <div class="note-actions">
                        <button onclick="saveNightNote(${nightNum})">Lưu ghi chú</button>
                    </div>
                </div>
            `;
        }
        
        // Chuyển đổi giữa các tab đêm
        function switchNightTab(nightNum) {
            // Cập nhật tab hiện tại
            currentNightTab = nightNum;
            
            // Cập nhật hiển thị tab
            const allTabs = document.querySelectorAll('.night-tab');
            allTabs.forEach(tab => {
                if (parseInt(tab.dataset.night) === nightNum) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Tải nội dung ghi chú của đêm đang chọn
            db.ref('games/' + currentGameCode + '/nightNotes/night' + nightNum).once('value').then(snapshot => {
                const noteData = snapshot.val();
                renderNightContent(nightNum, noteData ? noteData.content : '');
            }).catch(error => {
                console.error('Lỗi khi tải ghi chú:', error);
                renderNightContent(nightNum, '');
            });
        }
        
        // Lưu ghi chú đêm
        async function saveNightNote(nightNum) {
            const noteContent = document.getElementById('nightNote').value;
            
            try {
                await db.ref('games/' + currentGameCode + '/nightNotes/night' + nightNum).update({
                    content: noteContent,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                alert(`Đã lưu ghi chú Đêm ${nightNum} thành công!`);
                
            } catch (error) {
                console.error('Lỗi khi lưu ghi chú:', error);
                alert('Lỗi khi lưu ghi chú. Vui lòng thử lại!');
            }
        }
        
        // Thêm đêm mới
        async function addNewNight() {
            try {
                // Đọc tất cả các đêm hiện tại
                const snapshot = await db.ref('games/' + currentGameCode + '/nightNotes').once('value');
                const nightNotes = snapshot.val() || {};
                
                // Tìm số đêm cao nhất
                const nightNumbers = Object.keys(nightNotes)
                    .map(key => parseInt(key.replace('night', '')))
                    .sort((a, b) => a - b);
                
                const newNightNum = (nightNumbers.length > 0 ? nightNumbers[nightNumbers.length - 1] : 0) + 1;
                
                // Thêm đêm mới
                await db.ref('games/' + currentGameCode + '/nightNotes/night' + newNightNum).set({
                    content: '',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Cập nhật giao diện
                currentNightTab = newNightNum;
                renderNightTabs(newNightNum);
                renderNightContent(newNightNum, '');
                
            } catch (error) {
                console.error('Lỗi khi thêm đêm mới:', error);
                alert('Lỗi khi thêm đêm mới. Vui lòng thử lại!');
            }
        }
        
        // Hàm xóa phòng
        async function deleteRoom(code) {
            if (!code) {
                alert('Không có mã phòng!');
                return;
            }
            
            showConfirmModal(
                'Xóa phòng',
                `Bạn có chắc chắn muốn xóa phòng ${code}?`,
                async function() {
                    try {
                        // Xóa phòng
                        await db.ref('games/' + code).remove();
                        
                        if (code === currentGameCode) {
                            currentGameCode = '';
                            document.getElementById('adminGameInfo').classList.add('hidden');
                        }
                        
                        loadRooms(true);
                        alert('Đã xóa phòng thành công!');
                    } catch (error) {
                        console.error('Lỗi khi xóa phòng:', error);
                        alert('Lỗi khi xóa phòng. Vui lòng thử lại!');
                    }
                }
            );
        }
        
        // Hàm xóa phòng hiện tại
        function deleteCurrentRoom() {
            if (currentGameCode) {
                deleteRoom(currentGameCode);
            } else {
                alert('Không có phòng nào được chọn!');
            }
        }
    </script>
</body>
</html>
